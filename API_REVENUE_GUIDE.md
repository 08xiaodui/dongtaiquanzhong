# API调用收益分配系统 - 使用说明

## 概述

基于API调用次数的动态权重分配系统，从CSV表格中的"API调用次数"往回传导分配收益。

## CSV格式要求

新增两列：

| 列名 | 说明 | 示例 |
|------|------|------|
| **是否是API** | 标记任务是否为API（1=是，空=否） | `1` 或空 |
| **API调用次数** | 该API的调用次数（整数） | `1000`, `2000` |

**完整CSV列表**：
- 任务名称
- 任务执行人
- 父记录（引用关系）
- **是否是API**（新增）
- **API调用次数**（新增）

## 运行示例

### 测试数据

当前CSV包含：
- **5个API任务**（标记了调用次数）
- **总调用次数：7,000次**
  - 邀请码显示：1,000次（执行人：孤心匠）
  - 移动端邀请码联调：1,000次（执行人：王添乐）
  - 移动端邀请码流程优化：1,000次（执行人：雷明珠）
  - 队友上限设定：2,000次（执行人：孤心匠）
  - 前端部分 PC 手机端：2,000次（执行人：孤心匠）

### 运行命令

```bash
python demo_api_revenue.py --csv "csv/08小队网站V2项目管理_任务管理 (1).csv" --revenue-per-call 0.01 --debug
```

**参数说明**：
- `--csv`: CSV文件路径
- `--revenue-per-call`: 每次API调用的收益金额（例如：¥0.01元/次）
- `--debug`: 启用调试模式，保存中间结果到 `logs/` 目录

### 输出结果

```
用户                  直接收益     传导收益        总计     来源任务
--------------------------------------------------------------------
孤心匠                ¥35.00      ¥0.00       ¥35.00        3
木木                  ¥0.00       ¥8.82       ¥8.82         5
梁耀文                ¥0.00       ¥8.40       ¥8.40         2
王添乐                ¥7.00       ¥0.00       ¥7.00         1
雷明珠                ¥7.00       ¥0.00       ¥7.00         1
未分配                ¥0.00       ¥3.78       ¥3.78         5
--------------------------------------------------------------------
总计                                          ¥70.00
```

**收益分配逻辑**：
1. **总收益** = API调用次数 × 每次调用收益
2. **直接收益** = 执行人保留70%
3. **传导收益** = 30%向上游（父任务）传导，最多5层

## 收益传导示例

以"队友上限设定"为例（2000次调用，总收益¥20）：

```
队友上限设定 (孤心匠, 2000次, ¥20)
  └─ 保留70% = ¥14 → 孤心匠（直接收益）
  └─ 传导30% = ¥6 往上游
      │
      └─ 产品-确定奖赏机制 (梁耀文)
         └─ 保留70% of ¥6 = ¥4.2 → 梁耀文（传导收益）
         └─ 传导30% = ¥1.8 往上游
             │
             └─ 邀请码 (木木)
                └─ 保留70% of ¥1.8 = ¥1.26 → 木木（传导收益）
                └─ 传导30% = ¥0.54 往上游
                    │
                    └─ 搜索和发现学友 (未分配)
                       └─ 获得 ¥0.54 → 未分配
```

## 调试文件

启用 `--debug` 后生成的中间结果：

| 文件 | 说明 |
|------|------|
| `logs/api_01_csv_parse_result.json` | CSV解析结果（API任务统计） |
| `logs/api_02_nodes_construction.json` | 节点构建统计 |
| `logs/api_03_distribution_details.json` | 每个API任务的分配详情 |
| `logs/api_04_final_output.json` | 最终用户收益汇总 |

## 与原版demo.py的区别

| 特性 | demo.py（原版） | demo_api_revenue.py（新版） |
|------|----------------|---------------------------|
| **触发方式** | 指定单个任务 | 自动处理所有API任务 |
| **收益来源** | 手动指定总收益 | 基于API调用次数计算 |
| **适用场景** | 单次任务收益分配 | 批量API收益自动分配 |
| **CSV要求** | 基础列 | 需要"是否是API"和"API调用次数" |

## 使用建议

1. **每次API调用收益**：根据实际业务调整（例如：¥0.001 ~ ¥1）
2. **CSV维护**：定期更新API调用次数
3. **权重调整**：可修改传导率（默认30%）在代码中调整
4. **缺失执行人**：标记为"未分配"的任务会汇总到公共基金

## 下一步扩展

- [ ] 支持可配置的传导率（每个任务独立设置）
- [ ] 支持时间衰减（最近创建的任务权重更高）
- [ ] 支持难度补偿（实际工时 / 预估工时）
- [ ] Web Dashboard可视化
- [ ] 定时自动运行（每日/每周）
